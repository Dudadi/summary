# 分布式事务
## 两阶段提交 (two phase commit)
### [介绍](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)
#### 第一阶段(提交请求阶段)
1. 协调者节点向所有参与者节点询问是否可以执行提交操作，并开始等待各参与者节点的响应。
2. 参与者节点执行询问发起为止的所有事务操作，并将Undo信息和Redo信息写入日志。
3. 各参与者节点响应协调者节点发起的询问。如果参与者节点的事务操作实际执行成功，则它返回一个"同意"消息；如果参与者节点的事务操作实际执行失败，则它返回一个"中止"消息。
有时候，第一阶段也被称作投票阶段，即各参与者投票是否要继续接下来的提交操作。

#### 第二阶段(提交执行阶段)
成功
当协调者节点从所有参与者节点获得的响应消息都为"同意"时：
1. 协调者节点向所有参与者节点发出"正式提交"的请求。
2. 参与者节点正式完成操作，并释放在整个事务期间内占用的资源。
3. 参与者节点向协调者节点发送"完成"消息。
协调者节点收到所有参与者节点反馈的"完成"消息后，完成事务。
失败
如果任一参与者节点在第一阶段返回的响应消息为"终止"，或者协调者节点在第一阶段的询问超时之前无法获取所有参与者节点的响应消息时：
1. 协调者节点向所有参与者节点发出"回滚操作"的请求。
2. 参与者节点利用之前写入的Undo信息执行回滚，并释放在整个事务期间内占用的资源。
3. 参与者节点向协调者节点发送"回滚完成"消息。
4. 协调者节点收到所有参与者节点反馈的"回滚完成"消息后，取消事务。
有时候，第二阶段也被称作完成阶段，因为无论结果怎样，协调者都必须在此阶段结束当前事务。
### 优点缺点
请求阶段了提交阶段，需要所有节点都响应。如存在某个节点有问题，需要超时机制生效才会结束，由协调者通知其余节点进行回滚。策略偏保守；
如果存在资源占用的情况，阻塞的节点可能会导致跟事务无关的节点也需要等待。
## tcc (try - confirm - cancel)
### [介绍](https://trashcode.io/post/d/how-to-implement-distributed-transaction-2PC-or-TCC;jsessionid=B56C75FC9B00A60BE46B9C007ACCD5A5)
#### 准备阶段
测试系统并冻结资源
#### 确认阶段
确认并提交系统，如果准备阶段执行成功，则开始确认阶段。确保准备阶段成功，则确认阶段成功；
#### 取消阶段
回滚并释放资源
### 优点
简单
### 缺点
一致性不如2PC，可能再确认和取消阶段失败，还需要再写补偿逻辑
## saga
### [介绍](https://learn.microsoft.com/zh-cn/azure/architecture/reference-architectures/saga/saga)
定义一个事务中的每个子事务都有一个与之对应的反向补偿操作。每次执行一个子事务如果成功，添加改事务的回归补偿操作，并通知下一个子事务执行；
如果失败，需要将之前添加的所有回滚补偿操作全部执行。
### 优点

### 缺点
不适合循环依赖和紧密耦合事务
